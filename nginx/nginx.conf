# Nginx configuration for Pulsefolio API

# Redirects all HTTP traffic to HTTPS
server {
    listen 80;
    server_name your.domain.com; # <<< DOMAIN

    # Force all HTTP requests to redirect to HTTPS
    location / {
        # This location must be accessible for Certbot challenge verification
        if ($uri !~ ^/\.well-known/acme-challenge/) {
            return 301 https://$host$request_uri;
        }
    }
    
    # Required for Certbot verification
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
}

# Handles secure HTTPS traffic
server {
    listen 443 ssl;
    server_name your.domain.com; # <<< DOMAIN

    ssl_certificate /etc/letsencrypt/live/your.domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your.domain.com/privkey.pem;


    # --- Proxy Configuration to the Internal Docker API Service ---
    location / {
        # 'api' is the service name defined in docker-compose.prod.yml
        # '8080' is the internal port the .NET API exposes (ASPNETCORE_URLS: "http://0.0.0.0:8080")
        proxy_pass http://api:8080;
        
        # Set headers for reverse proxy 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Disable caching
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        
        # Handle Certbot verification during certificate issuance
        # This block is slightly redundant but useful as a fallback for Certbot
        if ($request_uri ~ ^/\.well-known/acme-challenge/) {
            root /var/www/certbot;
        }
    }

    # Optional: Increase body size limit for large requests (if necessary)
    client_max_body_size 50M;

    # Set up the location for Certbot verification
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
}